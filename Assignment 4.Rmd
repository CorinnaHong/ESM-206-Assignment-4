---
title: "Assignment 4"
author: "Corinna Hong"
date: "November 14, 2018"
output:
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}

library(tidyverse)
library(tidyr)
library(vcdExtra)
library(car)
library(onewaytests)
library(gridExtra)
library(kableExtra)
library(effsize)


```


```{r, include = FALSE}

# Read in data and put into tidy format

lobster_abundance <- read_csv("lobster_size_abundance.csv") %>% 
  as.data.frame(lobster_abundance) %>% # coerce tibbles into data.frame
  filter(COUNT != "0") %>% 
  expand.dft(freq = "COUNT") %>% # Give each lobster observation its own row
  select(YEAR, MONTH, DATE, SITE, SIZE)

lobster_traps <- read_csv("lobster_traps.csv") %>%
  filter(SITE == "IVEE"|SITE =="NAPL" |SITE == "AQUE"|SITE == "CARP" |SITE == "MOHK") %>% 
  select(YEAR, MONTH, DATE, SITE, TRAPS)

```



```{r, echo = FALSE, message= FALSE, warnings = FALSE, fig.align = "center", fig.width= 15, fig.height = 10}

# Create new datasets that group by site and then year. Total up # of obs for lobster measurements and sum number of traps

lobster_counts <- lobster_abundance %>%
  group_by(SITE, YEAR) %>% 
  summarize(
    COUNT = length(SIZE)
  )
  
traps_counts <- lobster_traps %>% 
  group_by(SITE, YEAR) %>% 
  summarize(
    TRAPS = sum(TRAPS))


# Merge data sets
suppressWarnings(abundance_traps <- full_join(lobster_counts, traps_counts)) 

# Graph first set of data (number of lobsters)
abundance_traps_line <- ggplot(abundance_traps, aes(x = YEAR, y = COUNT)) + 
  geom_line(aes(color = "COUNT")) +
  geom_point() +
  facet_wrap(~SITE, scale = "free", nrow = 3, ncol = 2) +
  labs(x = "Year", y = "Count") +
  theme_classic() +
  theme(text = element_text(family="sans")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) + # rotate x-axis and move labels down
  theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12)) +
  theme(legend.text=element_text(size=12)) +
  theme(legend.title=element_blank()) +
  theme(panel.spacing = unit(3, "lines")) +
  theme(strip.text = element_text(size = 10, margin = margin())) +
  scale_color_manual(values = c("skyblue", "skyblue4"))

# Add the second data set (number of traps)
abundance_traps_line <- abundance_traps_line + geom_line(aes(y = TRAPS, color = "TRAPS")) + 
  geom_point(aes(y = TRAPS))
abundance_traps_line

```
**Figure 1. Lobster Adundance and Fishing Pressure from 2012-2017.** Abundance (count) and fishing pressure (traps) per year for each of the five Long-Term Ecological Research (LTER) Sites in the Santa Barbara Channel. Abundance data was collected by divers in the late summer before the start of the fishing season and fishing pressure was determined by counting the number of commercial trap floats. Trap data was collected during the lobster fishing season. Data source: Reed, D. 2017. SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012. Santa Barbara Coastal Long Term Ecological Research Project. doi:10.6073/pasta/81ce20b29614ec99d85d54907eaa3e8e


```{r, echo = FALSE, message = FALSE, fig.align= "center"}

# New dataframe for only year 2017

size_2017 <- lobster_abundance %>% 
  filter(YEAR == 2017) %>% 
  select(SITE, SIZE) 



# Data exploration

#Histograms

size_2017_hist <- ggplot(size_2017, aes(x = SIZE)) +
  geom_histogram(bins = 12) +
  facet_wrap(~ SITE, scale = "free") + # Create a histogram, split graphic visualization by site. Give each histogram its own y-axis scale
  theme_classic()



# QQ-Plots

size_2017_qq <- ggplot(size_2017, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE, scale = "free") + # Create a Q-Q plot, split graphic visualization by site. Give each Q-Q Plot its own y-axis scale
  theme_classic()




# Question: Is there a significant difference in mean lobster size between the five sites?

# H0: There is no significant difference in mean lobster size between the five sites
# HA: There is a significant difference in mean lobster size between the five sites



# Levene's Test 

# H0: There are no differences in varance across groups (variances are equal)
# HA: There are differences in variances across groups (variances are not equal)

lobster_levene <- leveneTest(SIZE ~ SITE, data = size_2017)


# p < 0.05. Reject the null hypothesis. Our variances are differenct (Variances are not equal)



# What are the actual variances?

variances <- size_2017 %>% 
  group_by(SITE) %>%
    summarize(
    mean = round(mean(SIZE), 2),
    sd = round(sd(SIZE), 2),
    variance = round(var(SIZE), 2),
    n = length(SIZE)
  ) %>% 
  arrange(c("AQUE", "CARP", "MOHK", "IVEE", "NAPL")) 

variance_table <- kable(variances, align = rep('c', 6), caption = "**Table 1. Summary statistics of mean lobster size (mm) by site in 2017.** Mean, standard deviation and variance of lobster carapace length collected at sites in the Santa Barbara Channel. Arroyo Quemado (AQUE), Carpinteria (CARP), and Mohawk Reef (MOHK) are non-marine protected areas. Isla Vista (IVEE) and Naples Reef (NAPL) are marien protected areas. Data source: Reed, D. 2017. SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012. Santa Barbara Coastal Long Term Ecological Research Project. doi:10.6073/pasta/81ce20b29614ec99d85d54907eaa3e8e", col.names = c("Site", "Mean", "Standard Deviation", "Variance", "Sample Size")) %>% # Use kable on the table, center numeric data, give it a caption, rename columns
  kable_styling(bootstrap_options = c("striped","hover", "condensed"), full_width = F) %>% 
  column_spec(1, width = "10em", bold = T) %>% 
  column_spec(2, width = "10em") %>% 
  column_spec(3, width = "10em") %>% 
  column_spec(4, width = "10em") %>% 
  column_spec(5, width = "10em") %>% 
  row_spec(4:5, bold = T, color = "white", background = "grey")
  
  
variance_table

# Our largest variance is less than 4x larger than our smallest variance



# ONE-WAY ANOVA:

lobster_aov <- aov(SIZE ~ SITE, data = size_2017)
lobster_sum_aov <- summary(lobster_aov)


lobster_ph <- TukeyHSD(lobster_aov)


```



```{r, message = FALSE, fig.align= "center"}

# Column graph of means 

lobster_col <- ggplot(variances, aes (x = SITE, y = mean)) +
  geom_col() +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic()
lobster_col

```



```{r, include = FALSE}

# New data frame for year 2012

size_2012 <- lobster_abundance %>% 
  filter(YEAR == 2012) %>% 
  select(SITE, SIZE) 



# Data exploration

#Histograms

size_2012_hist <- ggplot(size_2012, aes(x = SIZE)) +
  geom_histogram(bins = 12) +
  facet_wrap(~ SITE, scale = "free") + # Create a histogram, split graphic visualization by site. Give each histogram its own y-axis scale
  theme_classic()


# QQ-Plots

size_2012_qq <- ggplot(size_2012, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE, scale = "free") + # Create a Q-Q plot, split graphic visualization by site. Give each Q-Q Plot its own y-axis scale
  theme_classic()
size_2012_qq


```


```{r, echo = FALSE, message = FALSE, fig.align = "center"}
# Question: How do lobster sizes in 2012 and 2017 compare?


#MPAs

# H0: There is no difference in mean lobster size in 2012 and 2017 in MPAs
# HA: There is a difference in mean lobster size in 2012 and 2017 in MPAs

# New dataframes with only MPA sites for 2012 and 2017

MPA_2012 <- size_2012 %>%
  filter(SITE == "IVEE" | SITE == "NAPL")


MPA_2017 <- size_2017 %>%
  filter(SITE == "IVEE" | SITE == "NAPL")


MPA <- lobster_abundance  %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  mutate(protected = case_when(
    SITE == "IVEE" ~ "MPA",
    SITE == "NAPL" ~ "MPA",
    SITE == "AQUE" ~ "Non-MPA",
    SITE == "CARP" ~ "Non-MPA",
    SITE == "MOHK" ~ "Non-MPA"
  ))

MPA_boxplot <- ggplot(MPA, aes(x=SITE, y= SIZE)) +
  geom_boxplot(aes(fill = protected))+
  facet_wrap(~ YEAR) +
  theme_classic()+
  scale_x_discrete(limits = c("AQUE", "CARP", "MOHK", "IVEE", "NAPL")) +
  xlab( "Site")+
  ylab(" Carapace Length (mm)")+
  ggtitle( "Size Distribution of Lobsters at MPA and Non-MPA Sites in the Santa Barbara Channel")+
  scale_fill_discrete(name ="Protected Status")+
  scale_fill_manual(values = c("skyblue", "skyblue4"))+
  theme(panel.spacing = unit(2, "lines"))

MPA_boxplot


# F-test for equal variances:

# H0: Variances are equal
# HA: Variances are not equal

f_test <- var.test(MPA_2012$SIZE, MPA_2017$SIZE)



# p = 0.33, retain the null. Variacnes are equal.



# Two-sided t-test for MPAs

MPA_ttest <- t.test(MPA_2012$SIZE, MPA_2017$SIZE, var.equal = TRUE)

# p = 0.056. Retain the null.

## Cohen's D


  
first <- MPA_2012 %>%
  pull(SIZE) 

second <- MPA_2017 %>% 
  pull(SIZE) 

effect_size <- cohen.d(first, second) 


## t-test results with cohen's d 


# Non-MPAS

# H0: There is no difference in mean lobster size in 2012 and 2017 in non-MPAs
# HA: There is a difference in mean lobster size in 2012 and 2017 in non-MPAs


# New data frams with only non-MPA sites

nMPA_2012 <- size_2012 %>%
  filter(SITE == "CARP" | SITE == "AQUE" | SITE == "MOHK")

nMPA_2017 <- size_2017 %>%
  filter(SITE == "CARP" | SITE == "AQUE" | SITE == "MOHK")

# F-test for equal variances:

# H0: Variances are equal
# HA: Variances are not equal

f_test2 <- var.test(nMPA_2012$SIZE, nMPA_2017$SIZE)


# p = 0.95, retain the null. Variances are equal.


# two sided t-test for non-MPAs

nMPA_ttest <- t.test(nMPA_2012$SIZE, nMPA_2017$SIZE, var.equal = TRUE)

# p = 0.007. Reject the null.

nMPA_1 <- MPA_2012 %>%
  pull(SIZE) 

nMPA_2 <- MPA_2017 %>% 
  pull(SIZE)

effect_size <- cohen.d(nMPA_1, nMPA_2) 

```
**Figure 2. Lobster size at MPA and non-MPA sites between 2012 and 2017.** Carapace length (mm) of California spiny lobster (*Panulirus interruptus*) 

```{r, echo =FALSE, message = FALSE}

### QUESTION 4:

legal_lobster <- lobster_abundance %>%
  mutate(size = ifelse(SIZE <= 82.6, "Not Legal", "Legal")) %>% 
  filter( YEAR == "2017")



legal_lobster_table <- legal_lobster %>% 
  count(SITE, size) %>% 
  spread(size, n) %>% 
  select(-SITE) %>% 
  arrange(c("AQUE", "CARP", "MOHK", "IVEE", "NAPL"))
  



suppressWarnings(rownames(legal_lobster_table) <- c("AQUE", "CARP", "MOHK", "IVEE", "NAPL"))

# Chi- sqaured test

chi_test <- chisq.test(legal_lobster_table)


chi_table <- kable(legal_lobster_table, align = rep('c', 6), caption = "**Table 2. Proportion of Observed Lobsters Above the Legal Carapace Length (82.6 mm)** Data source: Reed, D. . 2017. SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012. Santa Barbara Coastal Long Term Ecological Research Project. doi:10.6073/pasta/81ce20b29614ec99d85d54907eaa3e8e", col.names = c("Legal", "Not Legal")) %>% # Use kable on the table, center numeric data, give it a caption, rename columns
  kable_styling(bootstrap_options = c("striped","hover", "condensed"), full_width = F) %>% 
  column_spec(1, width = "10em", bold = T) %>% 
  column_spec(2, width = "10em") %>% 
  column_spec(3, width = "10em") %>% 
  row_spec(4:5, bold = T, color = "white", background = "grey")
chi_table
 

```


